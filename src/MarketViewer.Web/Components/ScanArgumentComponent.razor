@inject IJSRuntime JsRuntime;

<MudPaper Elevation="@(Argument.Depth * 2)" Class="ma-4" id="outer-dropzone">
    @if(Argument.Argument is null)
    {
        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Color="Color.Success" OnClick="AddArgument">Add Argument</MudButton>
    }
    else
    {
        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="RemoveArgument">Delete</MudButton>
        <ScanArgumentComponent Parent="@this" Argument="Argument.Argument"></ScanArgumentComponent>
    }
    <div class="dropdown">
        <select class="form-select m-2" style="width: 150px">
            <option selected value="1">AND</option>
            <option value="2">OR</option>
        </select>
    </div>
    <div id="@Argument.Id" class="card dropzone">
        @Argument.Id
        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Color="Color.Success" OnClick="AddFilter">Add Filter</MudButton>
        @foreach (var filter in Argument.Filters)
        {
            <MudPaper Elevation="10" id="@filter.Id" Class="d-flex drag-drop filter justify-space-between">
                @filter.Id
                <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => RemoveFilter(filter)">Delete</MudButton>
            </MudPaper>
        }
    </div>
</MudPaper>

@code {
    [CascadingParameter] public string PageId { get; set; }
    [Parameter] public ScanArgumentZone Argument { get; set; }
    [Parameter] public ScanArgumentComponent Parent { get; set; }

    private IJSInProcessRuntime JsInProcessRuntime;

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            JsInProcessRuntime = (IJSInProcessRuntime)JsRuntime;
        }
    }

    public void Render()
    {
        StateHasChanged();
    }

    private void AddArgument()
    {
        Argument.Argument = new ScanArgumentZone
        {
            Id = Guid.NewGuid().ToString(),
            Depth = Argument.Depth++,
            Filters = new List<FilterItem>()
        };
        JsInProcessRuntime.InvokeVoid("addArgumentToArgument", PageId, Argument.Id, Argument.Argument.Id);
    }

    private void RemoveArgument()
    {
        Argument.Argument = null;
        JsInProcessRuntime.InvokeVoid("removeArgumentFromArgument", PageId, Argument.Id);
    }   

    private void AddFilter()
    {
        var filter = new FilterItem();
        Argument.Filters.Add(filter);
        JsInProcessRuntime.InvokeVoid("addFilterToArgument", PageId, Argument.Id, filter.Id);

        if (Parent is not null)
        {
            Parent.Render();
        }
    }

    private void RemoveFilter(FilterItem filterItem)
    {
        Argument.Filters.Remove(filterItem);
        filterItem.Dispose();
        JsInProcessRuntime.InvokeVoid("removeFilterFromArgument", PageId, Argument.Id, filterItem.Id);
    }
}
